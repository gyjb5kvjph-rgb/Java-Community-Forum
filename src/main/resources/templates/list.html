<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/springsecurity6">
<head>
    <meta charset="UTF-8">
    <title>簡易掲示板</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<!-- ログイン/ログアウト表示 (変更なし) -->
<div style="text-align: right; margin-bottom: 10px;">
    <div sec:authorize="isAuthenticated()">
        こんにちは, <strong sec:authentication="name"></strong> さん |
        <form th:action="@{/logout}" method="post" style="display: inline;">
            <button type="submit" style="background: none; border: none; color: #007bff; cursor: pointer; padding: 0;">ログアウト</button>
        </form>
    </div>
    <div sec:authorize="isAnonymous()">
        <a href="/login">ログイン</a> | <a href="/register">新規登録</a>
    </div>
</div>

<h1>投稿一覧</h1>
<!-- ログインしている時だけ「新規投稿」リンクを表示 (変更なし) -->
<a href="/new" sec:authorize="isAuthenticated()">新規投稿はこちら</a>
<hr sec:authorize="isAuthenticated()">


<div th:each="post : ${posts}" style="border-bottom: 1px solid #ccc; padding: 10px;">
    <h2 th:text="${post.title}">ここにタイトルが入る</h2>
    <p th:text="${post.content}">ここに本文が入る</p>

    <!-- 投稿者名と日時の表示 (変更なし) -->
    <small>
        <strong>投稿者: </strong>
        <span th:if="${post.user != null}" th:text="${post.user.username}">ユーザー名</span>
        <span th:if="${post.user == null}">（不明）</span>
        |
        <span th:text="${#temporals.format(post.createdAt, 'yyyy/MM/dd HH:mm')}">投稿日時</span>
    </small>


    <!-- ▼▼▼ ここが修正箇所 ▼▼▼ -->
    <!--
     (修正) sec:authorize と th:if を分離します
     1. sec:authorize で「ログインしているか」をまずチェック
     2. th:if で「投稿者とログインユーザーが一致するか」をチェック
        (Thymeleafの #authentication オブジェクトを使います)
    -->
    <div style="margin-top: 10px;"
         sec:authorize="isAuthenticated()"
         th:if="${post.user != null and #authentication.name == post.user.username}">

        <a th:href="@{/edit/{id}(id=${post.id})}">編集</a>

        <a th:href="@{/delete/{id}(id=${post.id})}"
           style="margin-left: 10px; color: red;">削除</a>
    </div>
    <!-- ▲▲▲ ここまで ▲▲▲ -->

</div>

</body>
</html>